name: Release

on:
  release:
    types: [prereleased, released]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.release.tag_name }}
  cancel-in-progress: false

jobs:
  schema:
    name: Check Schema
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - name: Generate and compare schema with upstream bab release
        run: |
          # Get latest bab release tag
          TAG=$(curl -sf https://api.github.com/repos/bab-sh/bab/releases/latest | jq -r '.tag_name')
          echo "Latest bab release: $TAG"

          # Clone bab repo at release tag
          git clone --depth 1 --branch "$TAG" https://github.com/bab-sh/bab.git /tmp/bab

          # Generate schema from source
          cd /tmp/bab
          ./scripts/schema.sh

          # Compare with local schema
          cd -
          diff src/main/resources/schemas/babfile.schema.json /tmp/bab/schema/babfile.schema.json || {
            echo "::error::Schema outdated! Local schema doesn't match generated schema from bab ${TAG}"
            echo "::error::Run: curl -sL https://raw.githubusercontent.com/bab-sh/bab/${TAG}/schema/babfile.schema.json -o src/main/resources/schemas/babfile.schema.json"
            exit 1
          }
          echo "Schema is up to date with bab ${TAG}"

  publish:
    name: Publish Plugin
    needs: [schema]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          large-packages: false

      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.release.tag_name }}

      - uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 21

      - uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Validate Changelog Format
        run: ./gradlew getChangelog

      - name: Validate Version Consistency
        id: version
        run: |
          TAG_VERSION="${{ github.event.release.tag_name }}"
          TAG_VERSION="${TAG_VERSION#v}"
          GRADLE_VERSION=$(./gradlew properties --property version --quiet --console=plain | tail -n 1 | cut -f2- -d ' ')

          if [[ "$TAG_VERSION" != "$GRADLE_VERSION" ]]; then
            echo "::error::Version mismatch! Release tag: $TAG_VERSION, gradle.properties: $GRADLE_VERSION"
            exit 1
          fi

          echo "version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "::notice::Version validated: $TAG_VERSION"

      - name: Validate Changelog Entry
        run: |
          ./gradlew getChangelog --project-version="${{ steps.version.outputs.version }}" --no-header

      - name: Patch Changelog
        if: github.event.release.body != ''
        env:
          CHANGELOG: ${{ github.event.release.body }}
        run: |
          RELEASE_NOTE="./build/tmp/release_note.txt"
          mkdir -p "$(dirname "$RELEASE_NOTE")"
          echo "$CHANGELOG" > "$RELEASE_NOTE"
          ./gradlew patchChangelog --release-note-file="$RELEASE_NOTE"

      - name: Publish Plugin
        env:
          PUBLISH_TOKEN: ${{ secrets.PUBLISH_TOKEN }}
          CERTIFICATE_CHAIN: ${{ secrets.CERTIFICATE_CHAIN }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          PRIVATE_KEY_PASSWORD: ${{ secrets.PRIVATE_KEY_PASSWORD }}
        run: ./gradlew publishPlugin

      - name: Upload Release Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ github.event.release.tag_name }} ./build/distributions/*

      - name: Create Pull Request
        if: github.event.release.body != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BRANCH="changelog-update-$VERSION"
          LABEL="release changelog"

          git config user.email "action@github.com"
          git config user.name "GitHub Action"

          git checkout -b $BRANCH
          git commit -am "Changelog update - \`$VERSION\`"
          git push --set-upstream origin $BRANCH

          gh label create "$LABEL" \
              --description "Pull requests with release changelog update" \
              || true

          gh pr create \
              --title "Changelog update - \`$VERSION\`" \
              --body "Current pull request contains patched \`CHANGELOG.md\` file for the \`$VERSION\` version." \
              --label "$LABEL" \
              --head $BRANCH

      - name: Create Release Summary
        run: |
          echo "## Release Published Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ steps.version.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | \`${{ github.event.release.tag_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Type | ${{ github.event.action }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Plugin has been signed and published to [JetBrains Marketplace](https://plugins.jetbrains.com/plugin/27200-bab)." >> $GITHUB_STEP_SUMMARY
